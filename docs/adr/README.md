# 架構決策記錄 (ADR)

這裡記錄專案中的重大技術決策。

---

## 功能概覽

### 主要功能
- **21 項過濾規則**: 廣告、Shorts、會員專屬、新聞、貼文等
- **進階過濾**: 低觀看數、關鍵字、頻道、影片長度
- **繁簡通用**: 關鍵字過濾同時匹配繁體和簡體
- **反廣告封鎖**: 自動關閉 YouTube 的警告彈窗
- **新分頁開啟**: 點擊影片/通知時開新分頁
- **多語言**: 繁中、簡中、英文、日文
- **設定匯出**: JSON 格式備份還原

### 效能優化
- CSS 優先隱藏 (比 JS 快 10-100 倍)
- Debounce + requestIdleCallback
- 批次處理不卡畫面

## 決策列表

| # | 決策 | 簡述 |
|---|------|------|
| 1 | [CSS 優先](#1-css-優先) | 能用 CSS 隱藏就不用 JS |
| 2 | [最小依賴](#2-最小依賴) | 盡量不依賴外部套件 |
| 3 | [混合監控](#3-混合監控) | CSS + MutationObserver + 事件監聽 |
| 4 | [選擇器集中](#4-選擇器集中) | 所有 CSS 選擇器放在一起管理 |
| 5 | [原生彈窗](#5-原生彈窗) | 用 prompt/alert，不自己做 UI |
| 6 | [繁簡轉換](#6-繁簡轉換) | 用 OpenCC-JS + 備援機制 |

---

## 1. CSS 優先

**問題**: 如何高效隱藏 YouTube 上的元素？

**決策**: 優先用 CSS，需要計算才用 JS

**原因**:
- CSS 比 JS 快 10-100 倍
- CSS 在渲染前生效，不會閃爍
- 容易維護

**做法**:
```
第一層: CSS display:none (靜態元素)
第二層: CSS :has() (根據子元素判斷)
第三層: JS (需要數值計算，如觀看數)
```

---

## 2. 最小依賴

**問題**: 要不要用外部套件？

**決策**: 核心功能不依賴外部，增強功能可用 CDN

**原因**:
- 腳本保持輕量 (<100KB)
- CDN 掛掉時仍能運作
- 使用者可移除 @require

**做法**:
- 核心: 純 JS，無依賴
- 繁簡轉換: 用 OpenCC-JS (CDN)，有備援

---

## 3. 混合監控

**問題**: YouTube 是 SPA，內容動態載入，怎麼處理？

**決策**: 三種機制一起用

**做法**:
```
1. CSS 靜態規則 (document-start 就注入)
2. MutationObserver (監控 DOM 變化，debounce 150ms)
3. YouTube 事件 (yt-navigate-finish, yt-page-data-updated)
```

**優點**:
- 初始載入、動態內容、換頁都能處理
- Debounce 避免效能問題

---

## 4. 選擇器集中

**問題**: YouTube 常改版，選擇器散落各處難維護

**決策**: 所有選擇器放在 `SELECTORS` 常數

**做法**:
```javascript
const SELECTORS = {
    VIDEO_CONTAINERS: [
        'ytd-rich-item-renderer',
        'yt-lockup-view-model',  // 新版
    ],
    // ...
};
```

**優點**:
- YouTube 改版只改一處
- 容易支援 A/B 測試的不同版面

---

## 5. 原生彈窗

**問題**: 設定介面怎麼做？

**決策**: 用 Tampermonkey 選單 + prompt/alert

**原因**:
- 零維護成本
- 不受 YouTube UI 變化影響
- 程式碼精簡

**放棄的選項**:
- ❌ 自訂 Modal: 維護成本高，易與 YouTube 衝突
- ❌ 仿 YouTube UI: 維護成本極高，易失效

---

## 6. 繁簡轉換

**問題**: 關鍵字過濾要同時支援繁體和簡體

**決策**: 用 OpenCC-JS，掛掉時用備援

**做法**:
```javascript
// @require OpenCC-JS from CDN
// 有 -> 用 OpenCC
// 沒有 -> 用內建的簡易對照表
```

**優點**:
- 支援詞組轉換 (頭髮 vs 頭發)
- CDN 掛掉也能用
